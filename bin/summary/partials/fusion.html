<main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">{{ title }}</h1>
        <p>Generated {{ date }}</p>
    </div>
    <div>
        <section class="fusion" id="variations">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h1 class="h3">{{ variations.title }}</h1>
            </div>
            <table id="variation_table" class="table table-striped table-bordered">
                <thead>
                    <th>Source</th>
                    <th>Nucleotide</th>
                    <th>Left gene</th>
                    <th>Chromosome</th>
                    <th>Position</th>
                    <th>Strand</th>
                    <th>Right gene</th>
                    <th>Chromosome</th>
                    <th>Position</th>
                    <th>Strand</th>
                </thead>
                <tbody>
                    {% for row in variations.data %}
                    <tr>
                        <td>{{ row['source1'] }}</td>
                        <td><a href="https://www.ncbi.nlm.nih.gov/nuccore/{{ row['sample'] }}" target="_blank">{{ row['sample'] }}</a></td>
                        <td>{{ row['h_gene'] }}</td>
                        <td>{{ row['h_chr'] }}</td>
                        <td>{{ row['h_bp'] }}</td>
                        <td>{{ row['h_strand'] }}</td>
                        <td>{{ row['t_gene'] }}</td>
                        <td>{{ row['t_chr'] }}</td>
                        <td>{{ row['t_bp'] }}</td>
                        <td>{{ row['t_strand'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section class="fusion" id="transcripts">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h1 class="h3">{{ transcripts.title }}</h1>
            </div>
            <table id="transcripts_table" class="table table-striped table-bordered">
                <thead>
                    <th>Source</th>
                    <th>Type</th>
                    <th>Left gene transcript</th>
                    <th>Left gene</th>
                    <th>Chromosome</th>
                    <th>Position</th>
                    <th>Strand</th>
                    <th>Right gene transcript</th>
                    <th>Right gene</th>
                    <th>Chromosome</th>
                    <th>Position</th>
                    <th>Strand</th>
                </thead>
                <tbody>
                    {% for row in transcripts.data %}
                    <tr>
                        <td>{{ row['ctype1'] }}</td>
                        <td>{{ row['orf'] }}</td>
                        <td><a href="https://www.ensembl.org/id/{{ row['h_enst'] }}" target="_blank">{{ row['h_enst'] }}</a></td>
                        <td>{{ row['h_gene'] }}</td>
                        <td>{{ row['h_chr'] }}</td>
                        <td>{{ row['h_bp'] }}</td>
                        <td>{{ row['h_strand'] }}</td>
                        <td><a href="https://www.ensembl.org/id/{{ row['t_enst'] }}" target="_blank">{{ row['t_enst'] }}</a></td>
                        <td>{{ row['t_gene'] }}</td>
                        <td>{{ row['t_chr'] }}</td>
                        <td>{{ row['t_bp'] }}</td>
                        <td>{{ row['t_strand'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section class="fusion" id="ppi">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h1 class="h3">Protein-Protein interaction</h1>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Export graph as
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="#" onclick="export_image('png')">PNG</a>
                        <a class="dropdown-item" href="#" onclick="export_image('svg')">SVG</a>
                    </div>
                </div>
            </div>
            {% for graph_id in ppi.graphs.keys() %}
                <div class="{% if ppi.graphs.keys() | length == 1 %} col-md-6 mx-auto {% else %} col {% endif %}" id="{{ graph_id }}"></div>
            {% endfor %}
        </section>

        <section class="fusion" id="targeting_drugs">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h1 class="h3">{{ targeting_drugs.title }}</h1>
            </div>
            <table id="targeting_drug_table" class="table table-striped table-bordered">
                <thead>
                    <th>Gene</th>
                    <th>Drug Bank ID</th>
                    <th>Drug status</th>
                    <th>Drug status</th>
                    <th>Drug function</th>
                </thead>
                <tbody>
                    {% for row in targeting_drugs.data %}
                    <tr>
                        {% set drug_status = row['drug_status'].split('|') %}
                        <td>{{ row['gene_symbol'] }} ({{ row['uniprot_acc'] }})</td>
                        <td>{{ row['drug_name'] }} (<a href="https://www.drugbank.ca/drugs/{{ row['drug_bank_id'] }}">{{ row['drug_bank_id'] }}</a>) </td>
                        <td>
                            {% for status in drug_status %}
                                <p>{{ status }}</p>
                            {% endfor %}
                        </td>
                        <td>{{ row['drug_name'] }}</td>
                        <td>{{ row['drug_action'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section class="fusion" id="related_diseases">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                    <h1 class="h3">{{ related_diseases.title }}</h1>
                </div>
            <table id="targeting_drug_table" class="table table-striped table-bordered">
                <thead>
                    <th>Gene (Disease ID)</th>
                    <th>Disease description</th>
                    <th>Disease probability (%)</th>
                    <th>Disease publications</th>
                    <th>Disease source</th>
                </thead>
                <tbody>
                    {% for row in related_diseases.data %}
                    <tr>
                        <td>{{ row['gene'] }} (<a href="https://www.ncbi.nlm.nih.gov/medgen/{{ row['disease_id'] }}" target="_blank">{{ row['disease_id'] }}</a>) </td>
                        <td>{{ row['disease_desc'] }}</td>
                        <td>{{ row['disease_prob'] * 100 }}</td>
                        <td>{{ row['disease_pub'] }}</td>
                        <td>{{ row['disease_source'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
    </section>

    </div>
</main>
<script>
$(document).ready(function() {
    $('#variation_table, #transcripts_table, #targeting_drug_table, #ppi_table').DataTable();
});

ppi_graph_conf = {
    "$schema": "https://vega.github.io/schema/vega/v4.json",
    "width": 720,
    "height": 720,
    "padding": 5,
    "autosize": "none",
    "signals": [
        { "name": "originX", "update": "width / 2" },
        { "name": "originY", "update": "height / 2" }
    ],
    "data": [
        {
        "name": "tree",
        "values": '{{ ppi.graphs["ppi_graph"] | tojson | safe }}',
        "transform": [
            {
            "type": "stratify",
            "key": "id",
            "parentKey": "parent"
            },
            {
            "type": "tree",
            "method": "cluster",
            "size": [1, 280],
            "as": ["alpha", "radius", "depth", "children"]
            },
            {
            "type": "formula",
            "expr": "(360 * datum.alpha + 270) % 360",
            "as":   "angle"
            },
            {
            "type": "formula",
            "expr": "PI * datum.angle / 180",
            "as":   "radians"
            },
            {
            "type": "formula",
            "expr": "inrange(datum.angle, [90, 270])",
            "as":   "leftside"
            },
            {
            "type": "formula",
            "expr": "originX + datum.radius * cos(datum.radians)",
            "as":   "x"
            },
            {
            "type": "formula",
            "expr": "originY + datum.radius * sin(datum.radians)",
            "as":   "y"
            }
        ]
        },
        {
        "name": "links",
        "source": "tree",
        "transform": [
            { "type": "treelinks" },
            {
            "type": "linkpath",
            "shape": "diagonal", "orient": "radial",
            "sourceX": "source.radians", "sourceY": "source.radius",
            "targetX": "target.radians", "targetY": "target.radius"
            }
        ]
        }
    ],
    "scales": [
        {
        "name": "color",
        "type": "sequential",
        "range": {"scheme": "magma"},
        "domain": {"data": "tree", "field": "depth"},
        "zero": true
        }
    ],
    "marks": [
        {
        "type": "path",
        "from": {"data": "links"},
        "encode": {
            "update": {
            "x": {"signal": "originX"},
            "y": {"signal": "originY"},
            "path": {"field": "path"},
            "stroke": {"value": "#ccc"}
            }
        }
        },
        {
        "type": "symbol",
        "from": {"data": "tree"},
        "encode": {
            "enter": {
            "size": {"value": 100},
            "stroke": {"value": "#fff"}
            },
            "update": {
            "x": {"field": "x"},
            "y": {"field": "y"},
            "fill": {"scale": "color", "field": "depth"}
            }
        }
        },
        {
        "type": "text",
        "from": {"data": "tree"},
        "encode": {
            "enter": {
            "text": {"field": "name"},
            "fontSize": {"value": 9},
            "baseline": {"value": "middle"}
            },
            "update": {
            "x": {"field": "x"},
            "y": {"field": "y"},
            "dx": {"signal": "(datum.leftside ? -1 : 1) * 6"},
            "angle": {"signal": "datum.leftside ? datum.angle - 180 : datum.angle"},
            "align": {"signal": "datum.leftside ? 'right' : 'left'"},
            "opacity": 1
            }
        }
        }
    ]
};

var ppi_graph = new vega.View(vega.parse(ppi_graph_conf))
    .renderer('svg')
    .initialize('#ppi_graph')
    .hover()
    .run();

function export_image(type) {
    if (type == 'svg') {
        ppi_graph.toSVG().then(function(img) {
            var download = document.createElement('a');
            img = '<?xml version="1.0" standalone="no"?>\r\n' + img;
            var url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(img);
            download.href = url;
            download.download = 'ppi.svg';
            download.click();
        }).catch(function(error) {
            console.log(error);
        });
    }

    if (type == 'png') {
        ppi_graph.toImageURL('png').then(function(url) {
            var link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('target', '_blank');
            link.setAttribute('download', 'ppi.png');
            link.dispatchEvent(new MouseEvent('click'));
        }).catch(function(error) { 
            console.log(error);
         });
    }
}
</script>